<!DOCTYPE html>
<html>
<head>
    <title>Ikea Dimensions</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cousine:ital,wght@0,400;0,700;1,400;1,700&family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <!-- Data Visualization library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        body {
            /* background-color: black;
            color: white; */
            font-family: "Cousine", monospace;
            /* display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            width: 80%;
            height: auto;
            margin: auto; */
        }

        text, label {
            font-family: "Cousine", monospace;
        }

        h1 {
            font-family: "Instrument Serif", serif;
            /* font-style: normal;
            text-align: center;
            font-size: 30px;
            margin: 20px 0; */
        }

        h2, h3 {
            font-family: "Instrument Serif", serif;
        }

        .country {
        fill: lightgrey;
          }
          .outline {
            fill: none;
            stroke: black;
            stroke-width: 1px;
          }
    </style>
</head>
<body>
    <h1>
        Hello World Final Proj
    </h1>
    <svg id="choropleth" height="500" width="1000"></svg>

    <h2>Business Reactions to Trump's Tariffs</h2>
    <div class="dropdown">
      <label for="category-select">Filter by Category:</label>
      <select id="category-select">
        <option value="All">All</option>
      </select>
    </div>
    <div id="chart">
      <svg id="viz" width="800" height="800"></svg>
      <div id="details">
        <h3>Reaction</h3>
        <p id="reaction-text">Click a bubble to view details.</p>
      </div>
    </div>

    <p> Source: <a href="https://www.freightwaves.com/news/20-company-reactions-good-and-bad-to-trumps-tariff-war">Freight Waves</a> and <a href="https://www.pbs.org/newshour/show/how-businesses-are-dealing-with-the-impacts-of-trumps-tariff-policies">PBS</a></p>



    <script>
        const choropleth = d3.select("#choropleth");
        const mapWidth = choropleth.attr("width");
        const mapHeight = choropleth.attr("height");
        const mapMargin = { top: 20, right: 20, bottom: 20, left: 20};
        const mapAreaWidth = mapWidth - mapMargin.left - mapMargin.right;
        const mapAreaHeight = mapHeight - mapMargin.top - mapMargin.bottom;
        const map = choropleth.append("g")
                    
        
        const requestData = async function () {

          const world = await d3.json("dataset/countries-110m.json");
          const tariffData = await d3.csv("dataset/all.csv", d3.autoType);

          var countries = topojson.feature(world, world.objects.countries);     // List of state outlines to fill
          var countriesMesh = topojson.mesh(world, world.objects.countries);    // 'Mesh' of all outlines put together for a stroke
          var projection = d3.geoEqualEarth().fitSize([mapWidth, mapHeight], countries);
          var path = d3.geoPath().projection(projection);

          const minMax = d3.extent(tariffData, d => d["Tariffs Charged to USA (%)"]);
          const colorScale = d3.scaleQuantile()
            .domain(minMax)
            .range(["#fff","#d1e8ed","#adc2da","#8879b3","#762b80"]);

          const countryTariffs = {};
            tariffData.forEach(d => {
              countryTariffs[d.Country.trim()] = d["Tariffs Charged to USA (%)"];
            });

          map.selectAll("path.country").data(countries.features)
                       .join("path")
                       .attr("class", "country")
                       .attr("note", d => d.id) 
                       .attr("d", path)
                       .style("fill", d => {
                        const name = d.properties.name;
                        const tariff = countryTariffs[name];
                        return tariff != null ? colorScale(tariff) : "#ccc";
                      });
                    
          map.append("path").datum(countriesMesh)
            .attr("class","outline")
            .attr("d", path);



          // legend
          // Create a legend group
        const legend = choropleth.append("g")
          .attr("class", "legend")
          .attr("transform", `translate(${mapWidth - 150}, ${mapHeight - 250})`);

        // Legend title
        legend.append("text")
          .text("Tariffs Charged to USA (%)")
          .attr("y", -10)
          .attr("font-size", "12px")
          .attr("font-weight", "bold");

        // Get quantile thresholds and color range
        const thresholds = colorScale.quantiles();  // array of breakpoints
        const colors = colorScale.range();          // same order as thresholds

        // Draw legend entries
        colors.forEach((color, i) => {
          const x = 0;
          const y = i * 20;

          legend.append("rect")
            .attr("x", x)
            .attr("y", y)
            .attr("width", 18)
            .attr("height", 18)
            .attr("fill", color);

          let label;
          const from = i === 0 ? minMax[0] : thresholds[i - 1];
          const to = thresholds[i];

          if (i === colors.length - 1) {
            label = `${from.toFixed(1)}+`;
          } else {
            label = `${from.toFixed(1)} - ${to.toFixed(1)}`;
          }

          legend.append("text")
            .attr("x", x + 25)
            .attr("y", y + 13)
            .attr("font-size", "12px")
            .text(label);
        });

        };
        requestData();


        // business bubble
        const width = 800;
        const height = 500;

        const svg = d3.select("#viz")
          .attr("viewBox", [0, 0, width, height])
          .attr("style", "font: 10px sans-serif;");

        const color = d3.scaleOrdinal()
          .domain(["Positive", "Neutral", "Negative"])
          .range(["#2ca02c", "#ff7f0e", "#d62728"]);

        d3.csv("dataset/business_reactions.csv").then(data => {
          data.forEach(d => {
            d.market_cap = +d.market_cap;
          });

          const categories = Array.from(new Set(data.map(d => d.Category)));
          categories.forEach(cat => {
            d3.select("#category-select").append("option")
              .attr("value", cat)
              .text(cat);
          });

          let currentData = data;

          const draw = (filteredData) => {
            svg.selectAll("*").remove();

            const root = d3.pack()
              .size([width, height])
              .padding(5)(
                d3.hierarchy({ children: filteredData }).sum(d => d.market_cap)
              );

            const node = svg.selectAll("g")
              .data(root.leaves())
              .join("g")
              .attr("transform", d => `translate(${d.x},${d.y})`)
              .attr("class", "bubble")
              .on("click", function(event, d) {
                  d3.select("#reaction-text").text(d.data.Reaction);
              });
              
            node.append("circle")
              .attr("r", d => d.r + 2)  // slightly larger than image
              .attr("fill", "none")
              .attr("stroke", d => color(d.data.Sentiment))
              .attr("stroke-width", 3);

            // Add the image inside the circle
            node.append("image")
              .attr("href", d => d.data.image)
              .attr("width", d => d.r * 2)
              .attr("height", d => d.r * 2)
              .attr("x", d => -d.r)
              .attr("y", d => -d.r)
              .attr("clip-path", d => `circle(${d.r}px at ${d.r}px ${d.r}px)`);



            node.append("title")
              .text(d => `${d.data.Name}\n${d.data.Sentiment}`);

          };

          draw(currentData);

          d3.select("#category-select").on("change", function() {
            const selected = this.value;
            currentData = selected === "All" ? data : data.filter(d => d.Category === selected);
            draw(currentData);
          });
        });
    </script>
</body>
</html>
